#!/bin/sh
osascript <<APPLESCRIPT
  if (name of processes of application "System Events" as list contains "iTerm2") is false then
    activate application "iTerm"
  end if
APPLESCRIPT

iterm_scratchpad_id()
{
  kwmc query scratchpad list | sed -n -E "s/([0-9]+): ([0-9]+), iTerm2, scratchpad.*/\1/p"
}

toggle_scratchpad()
{
  local pad_id="$(iterm_scratchpad_id)"
  [[ -z "$pad_id" ]] && return
  osascript <<APPLESCRIPT
    tell application "iTerm2"
      repeat with aWindow in windows
        repeat with aTab in tabs of aWindow
          repeat with aSession in sessions of aTab
            if (profile name of aSession as string) = "scratchpad" then
              tell aWindow to select
              do shell script "kwmc scratchpad toggle ${pad_id}"
              return
            end if
          end repeat
        end repeat
      end repeat
    end tell
APPLESCRIPT
}

if [[ -z "$(iterm_scratchpad_id)" ]]; then
  osascript <<APPLESCRIPT
    tell application "iTerm2"
      set padWindow to (create window with profile "scratchpad")
      select padWindow
      delay 1
      do shell script "kwmc scratchpad add; kwmc scratchpad toggle $(iterm_scratchpad_id)"
    end tell
APPLESCRIPT
fi

toggle_scratchpad
